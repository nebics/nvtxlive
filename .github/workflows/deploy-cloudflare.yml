name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - 'release/novintix-*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean npm cache
        run: npm cache clean --force

      - name: Install dependencies (fresh)
        run: |
          rm -rf node_modules package-lock.json
          npm install

      - name: Clean previous build
        run: rm -rf dist .astro

      - name: Build Astro site
        run: npm run build

      - name: Extract project name from branch
        id: extract
        run: |
          # Branch: release/novintix-v3 -> Project: novintix-v3
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          PROJECT_NAME="${BRANCH_NAME#release/}"
          
          # Swap parts: novintix-v2 -> v2-novintix
          if [[ "$PROJECT_NAME" == *"-"* ]]; then
             IFS='-' read -r part1 part2 <<< "$PROJECT_NAME"
             if [ ! -z "$part2" ]; then
                 PROJECT_NAME="${part2}-${part1}"
             fi
          fi

          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "Deploying to Cloudflare Pages project: $PROJECT_NAME"


      - name: Add cache control headers
        run: |
          cat > dist/_headers << 'EOF'
          /*
            Cache-Control: no-cache, no-store, must-revalidate
            Pragma: no-cache
            Expires: 0
          EOF

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ steps.extract.outputs.project_name }} --branch=main --commit-dirty=true

      - name: Purge Cloudflare Cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' || echo "Cache purge skipped (no zone ID or pages.dev domain)"
        continue-on-error: true
