---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import "../styles/global.css";

interface Props {
  title: string;
  description?: string;
  currentPage?: string;
}

const {
  title,
  description = "NovintiX - Accelerate Transformation To Shape Your Future",
  currentPage = "",
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title} - NovintiX</title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  </head>
  <body>
    <Header currentPage={currentPage} />
    <main>
      <slot />
    </main>
    <Footer />

    <script is:inline>
      // Dynamic GA Injection
      (async () => {
        try {
          const stored = sessionStorage.getItem("ga_snippet");
          if (stored) {
            injectGA(stored);
          } else {
            const res = await fetch("/api/settings/analytics");
            const data = await res.json();
            if (data.snippet) {
              sessionStorage.setItem("ga_snippet", data.snippet);
              injectGA(data.snippet);
            }
          }
        } catch (e) {
          console.error("GA inject failed", e);
        }

        function injectGA(snippet) {
          if (!snippet) return;
          // Create a temporary container to parse the HTML string
          const div = document.createElement("div");
          div.innerHTML = snippet;

          // Append each script element to head/body
          Array.from(div.children).forEach((child) => {
            const newScript = document.createElement(child.tagName);
            Array.from(child.attributes).forEach((attr) =>
              newScript.setAttribute(attr.name, attr.value),
            );
            newScript.innerHTML = child.innerHTML;
            document.head.appendChild(newScript);
          });
        }
      })();
    </script>
  </body>
</html>
